name: "Link Health Check"

on:
  workflow_dispatch:
    inputs:
      file_to_check:
        description: 'ê²€ì‚¬í•  íŒŒì¼'
        required: false
        default: 'README.md'
        type: choice
        options:
          - 'README.md'
          - 'README_EN.md'
          - 'both'

  schedule:
    - cron: '0 9 * * 1'

  push:
    branches: [ main, master ]
    paths:
      - 'README.md'
      - 'README_EN.md'

jobs:
  check_links:
    name: "API ë§í¬ ìƒíƒœ ê²€ì‚¬"
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.9]

    steps:
      - name: ğŸ“ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp

      - name: ğŸ” README.md ë§í¬ ê²€ì‚¬
        id: check_readme
        if: github.event.inputs.file_to_check != 'README_EN.md'
        run: |
          echo "=== í•œêµ­ì–´ README ê²€ì‚¬ ì‹œì‘ ===" 
          python scripts/link_health_check.py README.md --save-json --concurrent 25
        continue-on-error: true

      - name: ğŸ” README_EN.md ë§í¬ ê²€ì‚¬
        id: check_readme_en
        if: github.event.inputs.file_to_check == 'README_EN.md' || github.event.inputs.file_to_check == 'both'
        run: |
          echo "=== ì˜ì–´ README ê²€ì‚¬ ì‹œì‘ ==="
          python scripts/link_health_check.py README_EN.md --save-json --concurrent 25
          mv link_health_report.json link_health_report_en.json
        continue-on-error: true

      - name: ğŸ“Š ê²€ì‚¬ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: link-health-reports
          path: |
            link_health_report.json
            link_health_report_en.json
          retention-days: 30

      - name: ğŸš¨ ê¹¨ì§„ ë§í¬ ì´ìŠˆ ìƒì„±
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            let brokenLinks = [];
            let reportContent = '';
            
            // í•œêµ­ì–´ README ê²°ê³¼ í™•ì¸
            try {
              const koReport = JSON.parse(fs.readFileSync('link_health_report.json', 'utf8'));
              const koBroken = koReport.results.filter(link => !link.is_working);
              brokenLinks = brokenLinks.concat(koBroken.map(link => ({...link, file: 'README.md'})));
            } catch (e) {
              console.log('í•œêµ­ì–´ ë¦¬í¬íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            // ì˜ì–´ README ê²°ê³¼ í™•ì¸
            try {
              const enReport = JSON.parse(fs.readFileSync('link_health_report_en.json', 'utf8'));
              const enBroken = enReport.results.filter(link => !link.is_working);
              brokenLinks = brokenLinks.concat(enBroken.map(link => ({...link, file: 'README_EN.md'})));
            } catch (e) {
              console.log('ì˜ì–´ ë¦¬í¬íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            if (brokenLinks.length > 0) {
              // ì—ëŸ¬ íƒ€ì…ë³„ë¡œ ê·¸ë£¹í™”
              const errorGroups = {};
              brokenLinks.forEach(link => {
                const errorType = link.error_type;
                if (!errorGroups[errorType]) {
                  errorGroups[errorType] = [];
                }
                errorGroups[errorType].push(link);
              });
            
              let issueBody = `## ğŸš¨ ë§í¬ ë¶€íŒ¨ ê°ì§€ ì•Œë¦¼\n\n`;
              issueBody += `**ì´ ${brokenLinks.length}ê°œì˜ ê¹¨ì§„ ë§í¬ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.**\n\n`;
            
              // ì—ëŸ¬ íƒ€ì…ë³„ ìƒì„¸ ë‚´ìš©
              for (const [errorType, links] of Object.entries(errorGroups)) {
                issueBody += `### ğŸ“‹ ${errorType} (${links.length}ê°œ)\n\n`;
            
                links.forEach(link => {
                  issueBody += `- âŒ **[${link.api_name}](${link.url})**\n`;
                  issueBody += `  - ğŸ“ íŒŒì¼: ${link.file}\n`;
                  issueBody += `  - ğŸ“‚ ì¹´í…Œê³ ë¦¬: ${link.category}\n`;
                  issueBody += `  - âš ï¸ ì˜¤ë¥˜: ${link.error_message}\n`;
                  if (link.redirect_url) {
                    issueBody += `  - ğŸ”„ ë¦¬ë‹¤ì´ë ‰íŠ¸: ${link.redirect_url}\n`;
                  }
                  issueBody += `\n`;
                });
              }
            
              issueBody += `\n### ğŸ”§ ìˆ˜ì • ë°©ë²•\n\n`;
              issueBody += `1. **ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸**: í•´ë‹¹ API ì„œë¹„ìŠ¤ê°€ ì¢…ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸\n`;
              issueBody += `2. **URL ë³€ê²½ í™•ì¸**: ê³µì‹ ë¬¸ì„œì—ì„œ ìƒˆë¡œìš´ URL í™•ì¸\n`;
              issueBody += `3. **ëŒ€ì²´ ì„œë¹„ìŠ¤ ì¡°ì‚¬**: ë™ì¼í•œ ê¸°ëŠ¥ì˜ ëŒ€ì²´ API ì¡°ì‚¬\n`;
              issueBody += `4. **í•­ëª© ì œê±°**: ë³µêµ¬ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° í•´ë‹¹ í•­ëª© ì œê±°\n\n`;
              issueBody += `---\n`;
              issueBody += `**ìë™ ìƒì„± ì‹œê°„**: ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}\n`;
              issueBody += `**ê²€ì‚¬ ì£¼ê¸°**: ë§¤ì£¼ ì›”ìš”ì¼\n`;

              // ì´ìŠˆ ìƒì„±
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ”— ì£¼ê°„ ë§í¬ ìƒíƒœ ì ê²€: ${brokenLinks.length}ê°œ ë§í¬ ìˆ˜ì • í•„ìš”`,
                body: issueBody,
                labels: ['ğŸ› bug', 'ğŸ”— link-rot', 'ğŸ”§ maintenance', 'ğŸ“‹ weekly-check']
              });
            
              console.log(`ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${brokenLinks.length}ê°œ ê¹¨ì§„ ë§í¬`);
            } else {
              console.log('ëª¨ë“  ë§í¬ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤! ğŸ‰');
            }

      - name: ğŸ’¬ PRì— ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
        if: github.event_name == 'pull_request' && (failure() || success())
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            let allBroken = [];
            let totalLinks = 0;
            let workingLinks = 0;
            
            // ê²°ê³¼ íŒŒì¼ë“¤ ì½ê¸°
            try {
              const koReport = JSON.parse(fs.readFileSync('link_health_report.json', 'utf8'));
              totalLinks += koReport.total_links;
              workingLinks += koReport.working_links;
              const koBroken = koReport.results.filter(link => !link.is_working);
              allBroken = allBroken.concat(koBroken.map(link => ({...link, file: 'README.md'})));
            } catch (e) {}
            
            try {
              const enReport = JSON.parse(fs.readFileSync('link_health_report_en.json', 'utf8'));
              totalLinks += enReport.total_links;
              workingLinks += enReport.working_links;
              const enBroken = enReport.results.filter(link => !link.is_working);
              allBroken = allBroken.concat(enBroken.map(link => ({...link, file: 'README_EN.md'})));
            } catch (e) {}
            
            const successRate = totalLinks > 0 ? ((workingLinks / totalLinks) * 100).toFixed(1) : 0;
            
            let commentBody = `## ğŸ”— ë§í¬ ìƒíƒœ ê²€ì‚¬ ê²°ê³¼\n\n`;
            
            if (allBroken.length === 0) {
              commentBody += `âœ… **ëª¨ë“  ë§í¬ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!**\n\n`;
              commentBody += `ğŸ“Š **í†µê³„**: ${totalLinks}ê°œ ë§í¬ ì¤‘ ${workingLinks}ê°œ ì •ìƒ (${successRate}%)\n`;
            } else {
              commentBody += `âš ï¸ **ì¼ë¶€ ë§í¬ì— ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.**\n\n`;
              commentBody += `ğŸ“Š **í†µê³„**: ${totalLinks}ê°œ ë§í¬ ì¤‘ ${allBroken.length}ê°œ ë¬¸ì œ (ì„±ê³µë¥ : ${successRate}%)\n\n`;
              commentBody += `### ğŸš¨ ë¬¸ì œê°€ ìˆëŠ” ë§í¬ë“¤:\n\n`;
            
              allBroken.slice(0, 10).forEach(link => {
                commentBody += `- âŒ **${link.api_name}** (${link.file})\n`;
                commentBody += `  - URL: ${link.url}\n`;
                commentBody += `  - ì˜¤ë¥˜: ${link.error_message}\n\n`;
              });
            
              if (allBroken.length > 10) {
                commentBody += `... ê·¸ë¦¬ê³  ${allBroken.length - 10}ê°œ ë”\n\n`;
              }
            
              commentBody += `ğŸ”§ **ìˆ˜ì • í›„ ë‹¤ì‹œ ê²€ì‚¬ë¥¼ ë°›ìœ¼ì‹œê¸° ë°”ëë‹ˆë‹¤.**\n`;
            }
            
            commentBody += `\n---\n ë§í¬ ìƒíƒœ ìë™ ê²€ì‚¬`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
            
